# Run services as current user to avoid permission issues with mounted volumes
x-user: &current-user
  user: "${UID:-1000}:${GID:-1000}"

services:
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"

  auth-service:
    <<: *current-user
    build:
      context: ./
      dockerfile: ./auth-service/Dockerfile
    volumes:
      - ./auth-service:/app/auth-service
      - /app/node_modules  # Avoid overwriting node_modules inside the container
    ports:
      - "4000:4000"
    depends_on:
      rabbitmq:
        condition: service_started
      db:
        condition: service_started
      mailhog:
        condition: service_started
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/auth_service
      - JWT_SECRET=your_jwt_secret
      - RABBITMQ_URL=amqp://rabbitmq

  url-service:
    <<: *current-user
    build:
      context: ./
      dockerfile: ./url-service/Dockerfile
    volumes:
      - ./shared:/app/shared
      - ./url-service:/app/url-service
      - /app/node_modules
    ports:
      - "5000:5000"
    depends_on:
      rabbitmq:
        condition: service_started
      db:
        condition: service_started
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/url_service
      - JWT_SECRET=your_jwt_secret
      - RABBITMQ_URL=amqp://rabbitmq

  analytics-service:
    <<: *current-user
    build:
      context: ./
      dockerfile: ./analytics-service/Dockerfile
    volumes:
      - ./shared:/app/shared
      - ./analytics-service:/app/analytics-service
      - /app/node_modules
    ports:
      - "6000:6000"
    depends_on:
      rabbitmq:
        condition: service_started
      db:
        condition: service_started
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/analytics_service
      - JWT_SECRET=your_jwt_secret
      - RABBITMQ_URL=amqp://rabbitmq

  notification-service:
    <<: *current-user
    build:
      context: ./
      dockerfile: ./notification-service/Dockerfile
    volumes:
      - ./shared:/app/shared
      - ./notification-service:/app/notification-service
      - /app/node_modules
    ports:
      - "7000:7000"
    depends_on:
      rabbitmq:
        condition: service_started
      db:
        condition: service_started
    environment:
      - SMTP_HOST=mailhog
      - SMTP_PORT=1025
      - EMAIL_USER=notification@bear.link
      - EMAIL_PASS=test_password
      - RABBITMQ_URL=amqp://rabbitmq

  web-ui:
    <<: *current-user
    build: ./web-ui
    volumes:
      - ./web-ui:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    depends_on:
      - auth-service
      - url-service
      - analytics-service
    environment:
      - NEXT_PUBLIC_AUTH_SERVICE_URL=http://localhost:4000  # URL for the auth-service
      - NEXT_PUBLIC_URL_SERVICE_URL=http://localhost:5000  # URL for the url-service
      - NEXT_PUBLIC_ANALYTICS_SERVICE_URL=http://localhost:6000  # URL for the analytics-service

  db:
    image: postgres:latest
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5432:5432"
    volumes:
      - ./infra/db/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
      # - pgdata:/var/lib/postgresql/data

  mailhog:
    image: mailhog/mailhog
    ports:
      - "1025:1025"  # SMTP server
      - "8025:8025"  # Web UI

volumes:
  pgdata: