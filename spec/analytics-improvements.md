# Analytics Service Improvements

> **Status:** approved
> **Service(s):** analytics-service
> **Priority:** high

## Goal

The analytics-service currently stores raw events but offers no way to query them
meaningfully. It has no authentication, no pagination, no aggregation, and no data
lifecycle management. This spec makes it a real analytics service rather than a
write-only event log.

## Background

The service exposes a single `GET /events` endpoint that returns every row in the
database with no filtering or pagination. As data grows this will degrade performance
and eventually become unusable. The endpoint is also completely unauthenticated, leaking
user emails and URL data to any caller. There are no indexes on the Event table.

## Requirements

### Functional

- **R1:** `GET /events` shall require JWT authentication. Admin users see all events;
  regular users see only events related to their own user ID.
- **R2:** `GET /events` shall support pagination via `page` and `limit` query parameters,
  defaulting to page 1, limit 50. The response shall include total count.
- **R3:** `GET /events` shall support filtering by `type`, `from` (ISO date), `to` (ISO
  date), and `userId`.
- **R4:** The service shall expose `GET /analytics/urls/:shortId/clicks` returning total
  click count and today's click count for the given URL.
- **R5:** The service shall expose `GET /analytics/summary` (admin only) returning total
  user count, total URL count, and total click count across all time.
- **R6:** The service shall expose `GET /analytics/top-urls` (admin only) returning the
  top N URLs by click count for a given time period (`period` query param, e.g. `7d`,
  `30d`; `limit` query param, default 10).
- **R7:** The service shall run a daily cleanup job that deletes events older than a
  configurable retention period (default 90 days, controlled by `EVENT_RETENTION_DAYS`
  env var).
- **R8:** Event payloads shall be validated against per-type schemas before being
  persisted. Invalid payloads shall be rejected with a log warning, not stored silently.

### Non-Functional

- **R9:** The `Event` table shall have indexes on `type`, `createdAt`, and the composite
  `(type, createdAt)` to support efficient filtering queries.
- **R10:** Aggregation queries shall not load raw rows into memory; use database-level
  aggregation (`COUNT`, `GROUP BY`).

## Acceptance Criteria

- [ ] `GET /events` without a token returns 401.
- [ ] `GET /events` with a regular user token returns only events where the payload
  `userId` matches the authenticated user.
- [ ] `GET /events` with an admin token returns all events.
- [ ] `GET /events?page=2&limit=10` returns the correct page and includes
  `{ pagination: { page, limit, total } }` in the response.
- [ ] `GET /events?type=url_clicked` returns only events of that type.
- [ ] `GET /events?from=2026-01-01&to=2026-02-01` returns only events in that range.
- [ ] `GET /analytics/urls/:shortId/clicks` returns `{ total, today }`.
- [ ] `GET /analytics/summary` with a non-admin token returns 403.
- [ ] `GET /analytics/summary` with an admin token returns `{ totalUsers, totalUrls, totalClicks }`.
- [ ] `GET /analytics/top-urls?period=7d&limit=5` returns at most 5 results ordered by
  click count descending.
- [ ] Publishing an event with an unknown type logs a warning and does not persist it.
- [ ] Publishing a `url_clicked` event missing the `shortId` field logs a warning and
  does not persist it.
- [ ] Events older than `EVENT_RETENTION_DAYS` are removed by the cleanup job.

## Out of Scope

- Real-time streaming or WebSocket-based analytics
- Per-country or per-device breakdown (belongs in a future geo-analytics spec)
- Migrating or back-filling existing event data
- A dashboard UI (belongs in web-ui spec)

## Tasks

<!-- Generated by Claude from the requirements above. Do not write these manually. -->
