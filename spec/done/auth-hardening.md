# Auth Service Hardening

> **Status:** done
> **Service(s):** auth-service, shared, web-ui
> **Priority:** critical

## Goal

The auth-service has several security gaps that make it unsuitable for production: JWTs
are stored in localStorage (XSS-vulnerable), secrets are hardcoded in version control,
failed login attempts have no lockout, and there is no CSRF protection once cookies are
introduced. This spec closes those gaps.

## Background

Current state:
- `JWT_SECRET=your_jwt_secret` is committed to `docker-compose.yml`
- The frontend stores JWTs in `localStorage`, accessible to any injected script
- The `DELETE /users/:userId` endpoint has no error handling (no try/catch, no 404 check)
- There is no account lockout after repeated failed logins

## Requirements

### Functional

- **R1:** On successful login, the auth-service shall set the JWT as an `httpOnly`,
  `Secure` (in production), `SameSite=strict` cookie named `token`. The response body
  shall return user data but not the token string.
- **R2:** The auth-service shall expose `POST /logout` which clears the `token` cookie
  and returns 204.
- **R3:** The shared `authenticateJWT` middleware shall read the token from the `token`
  cookie first, falling back to the `Authorization: Bearer` header for API clients.
- **R4:** The web-ui shall use `withCredentials: true` on all Axios requests. All
  `localStorage` token read/write logic shall be removed.
- **R5:** All secret values (`JWT_SECRET`, `DATABASE_URL`, etc.) shall be sourced from
  environment variables or a `.env.secrets` file that is not committed to git.
  `docker-compose.yml` shall use `env_file` to reference this file.
- **R6:** `DELETE /users/:userId` shall validate the userId, return 404 if the user does
  not exist, return 400 if an admin attempts to delete their own account, and wrap the
  operation in a try/catch with structured error logging.
- **R7:** After 5 consecutive failed login attempts for an email address, the auth-service
  shall return 429 for that email for 15 minutes. A successful login resets the counter.
- **R8:** The auth-service shall expose `GET /csrf-token` which returns a CSRF token.
  All state-mutating endpoints (POST, PUT, PATCH, DELETE) shall validate the
  `X-CSRF-Token` header when cookie auth is in use.

### Non-Functional

- **R9:** The account lockout store may be in-memory for now (single instance). It shall
  be extracted behind an interface so it can be swapped for Redis later.
- **R10:** Cookie configuration shall be driven by `NODE_ENV`: `Secure` flag only in
  production, to allow HTTP in local development.

## Acceptance Criteria

- [ ] After login, the response sets a `Set-Cookie: token=...;HttpOnly` header.
- [ ] The response body after login does not contain a `token` field.
- [ ] `POST /logout` clears the `token` cookie and returns 204.
- [ ] `GET /profile` succeeds when the JWT is sent via cookie (no Authorization header).
- [ ] The web-ui makes requests without reading from or writing to `localStorage`.
- [ ] `docker-compose.yml` does not contain any literal secret values.
- [ ] `DELETE /users/:userId` with a non-existent ID returns 404.
- [ ] `DELETE /users/:userId` where the target is the authenticated admin returns 400.
- [ ] After 5 failed login attempts, a 6th attempt with the correct password returns 429.
- [ ] After a successful login, a subsequent failed login resets and does not immediately
  lock the account.
- [ ] A POST request without a valid CSRF token returns 403 when using cookie auth.

## Out of Scope

- OAuth / SSO integration
- Refresh token rotation
- Password reset / forgot-password flow
- Two-factor authentication
- Migrating existing sessions (users will need to log in again after deployment)

## Tasks

<!-- Generated by Claude from the requirements above. Do not write these manually. -->

### T1 — Set JWT as httpOnly cookie on login (R1, R10)
In `auth-service/controllers/auth.controller.js`, replace `res.json({ token: generateToken(user) })` with `res.cookie('token', token, { httpOnly: true, secure: process.env.NODE_ENV === 'production', sameSite: 'strict', maxAge: 3600000 })` followed by `res.json({ user: sanitizeUser(user) })`. Ensure the token string is not included in the response body. Add `cookie-parser` middleware to `auth-service` if not already present.

### T2 — Add POST /logout endpoint (R2)
Add a `logout` handler to `auth-service/controllers/auth.controller.js` that calls `res.clearCookie('token')` and returns 204. Register `router.post('/logout', controller.logout)` in `auth-service/routes/auth.routes.js`.

### T3 — Update authenticateJWT to read from cookie (R3)
In `shared/middlewares/auth.js`, update the token extraction line to read from the cookie first:
`const token = req.cookies?.token || req.headers.authorization?.split(' ')[1]`. Ensure `cookie-parser` is applied before this middleware in all services that use it.

### T4 — Remove localStorage from web-ui, add withCredentials (R4)
In `web-ui/src/lib/axios.ts`, add `withCredentials: true` to the Axios instance config and remove the `localStorage.getItem('token')` interceptor logic. In `web-ui/src/lib/auth.ts` (and anywhere else), remove all `localStorage.setItem('token', ...)` and `localStorage.removeItem('token')` calls. The browser will handle the cookie automatically.

### T5 — Move hardcoded secrets out of docker-compose.yml (R5)
Create a `.env.secrets.example` file at the repo root documenting all required secrets. Add `.env.secrets` to `.gitignore`. Update `docker-compose.yml` to use `env_file: - .env.secrets` for each service and remove hardcoded values for `JWT_SECRET`, `DATABASE_URL` passwords, `POSTGRES_PASSWORD`, and `EMAIL_PASS`.

### T6 — Fix DELETE /users/:userId error handling (R6)
In `auth-service/controllers/users.controller.js`, wrap `deleteUser` in a try/catch. Before deleting, check that the user exists (`prisma.user.findUnique`) and return 404 if not. Check that `req.user.id !== userId` and return 400 if an admin attempts to delete their own account. Log the deletion with `logger.info`.

### T7 — Implement login attempt tracking and account lockout (R7, R9)
Create `auth-service/services/loginAttempts.js` that exports `recordFailedAttempt(email)`, `isLocked(email)`, and `clearAttempts(email)` backed by an in-memory Map. Lock threshold: 5 attempts, lockout duration: 15 minutes. In `auth-service/controllers/auth.controller.js`, call `isLocked(email)` before credential verification (return 429 if locked), call `recordFailedAttempt(email)` on failure, and `clearAttempts(email)` on success.

### T8 — Add CSRF token endpoint and validation (R8)
Install `csurf` and ensure `cookie-parser` is present. In `auth-service`, add `GET /csrf-token` that returns `{ csrfToken: req.csrfToken() }`. Apply the CSRF middleware to all state-mutating routes (POST, PUT, PATCH, DELETE). In the web-ui, fetch the CSRF token on app load and include it as `X-CSRF-Token` header on all mutating requests.
