# Redis-backed Login Attempt Store

> **Status:** draft
> **Service(s):** auth-service
> **Priority:** medium

## Goal

The current login attempt store is in-memory, meaning each auth-service instance
maintains its own isolated counter. In a horizontally-scaled deployment (multiple
pods/containers) an attacker can spread failed login attempts across instances and
never trigger the lockout threshold. Moving the store to Redis makes the counter
shared across all instances and restores the intended security guarantee.

## Background

`auth-service/services/loginAttempts.js` exports `createLoginAttemptStore()`, a
factory that returns `{ isLocked, recordFailedAttempt, clearAttempts }` backed by
a plain `Map`. The store is injected into `createApp()` via dependency injection,
so the controller and routes are completely unaware of the backing implementation —
they only call the three interface functions.

Redis is already part of the BearLink stack: the url-service uses it for URL
caching and click deduplication (see `REDIS_URL` in docker-compose.yml). The
auth-service does not currently declare a Redis dependency.

## Requirements

### Functional

- **R1:** When `REDIS_URL` is set, the auth-service shall use a Redis-backed
  `loginAttemptStore`. When `REDIS_URL` is unset, it shall fall back to the
  existing in-memory store so that local development and tests require no Redis.
- **R2:** The Redis store shall implement the same interface as the in-memory store:
  `isLocked(email)`, `recordFailedAttempt(email)`, `clearAttempts(email)`. No
  other code shall change.
- **R3:** `recordFailedAttempt` shall increment a Redis counter key
  (`login_attempts:{email}`) using `INCR`. On reaching the lockout threshold (5)
  the store shall set a lock key (`login_locked:{email}`) with `SET NX EX 900`
  (15 minutes TTL).
- **R4:** `isLocked` shall check for the existence of the lock key only. Redis TTL
  handles expiry automatically — no manual timestamp comparison is needed.
- **R5:** `clearAttempts` shall delete both keys atomically.
- **R6:** If the Redis connection is unavailable at request time, the store shall
  log a warning and degrade gracefully: `isLocked → false`,
  `recordFailedAttempt → no-op`, `clearAttempts → no-op`. This trades per-instance
  lockout for full service availability during Redis downtime.

### Non-Functional

- **R7:** The Redis client shall use `ioredis` (already a dependency of url-service
  — no new package added at the monorepo level).
- **R8:** Redis keys shall use a consistent prefix (`login_attempts:`,
  `login_locked:`) to avoid collisions with other services sharing the same Redis
  instance.
- **R9:** The in-memory store (`createLoginAttemptStore`) shall remain unchanged and
  continue to be used in all unit tests — no Redis instance required to run tests.
- **R10:** The `docker-compose.yml` auth-service definition shall declare
  `depends_on: redis` and set `REDIS_URL=redis://redis:6379`.

## Acceptance Criteria

- [ ] With `REDIS_URL` set, failed attempts are visible in Redis (`redis-cli keys
  "login_*"`) and count correctly across two app instances sharing the same Redis.
- [ ] After 5 failed attempts, `GET login_locked:{email}` exists in Redis with a TTL
  close to 900 seconds.
- [ ] After a successful login, both Redis keys for that email are deleted.
- [ ] With `REDIS_URL` unset, the service starts normally and falls back to the
  in-memory store (existing behaviour unchanged).
- [ ] When Redis is unreachable mid-request, the auth-service returns 200/400
  normally (no 500) and a warning is emitted in the logs.
- [ ] `docker-compose up` starts the auth-service connected to Redis with no manual
  configuration.

## Out of Scope

- Redis-backed CSRF token store
- Distributed rate limiting for endpoints other than login
- Redis-backed session store or token blacklist
- Redis Sentinel / Cluster configuration
- Migrating existing locked accounts (in-memory state is ephemeral anyway)

## Docs to Update

- [ ] `CLAUDE.md` — update `REDIS_URL` description from "url-service only" to
  include auth-service; document the graceful-degradation behaviour

## Tasks

<!--
Generated by Claude from the requirements above. Do not write these manually.
Ask Claude: "Generate tasks for this spec."
-->
