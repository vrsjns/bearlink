# CSRF Protection for All Services

> **Status:** draft
> **Service(s):** url-service, analytics-service, shared
> **Priority:** medium

## Goal

CSRF protection currently exists only in auth-service. All backend services
share the same cookie-based authentication (after the auth-hardening spec), so
url-service and analytics-service are also exposed to CSRF attacks on their
state-mutating endpoints. This spec moves the CSRF middleware and token service
into `shared/` so every service can opt in with minimal wiring.

## Background

The auth-hardening spec (now complete) introduced:
- A `token` cookie (`httpOnly`, `SameSite=strict`) on all services via the shared
  `authenticateJWT` middleware
- A CSRF token endpoint (`GET /csrf-token`) and validation middleware in
  auth-service only
- The CSRF token is `HMAC-SHA256(JWT_SECRET, token_cookie)` — stateless and valid
  across all services because they share the same `JWT_SECRET`

Current exposure:
- `url-service` — `POST /urls`, `PUT /urls/:id`, `DELETE /urls/:id`, and other
  mutating endpoints accept cookie auth but do not validate `X-CSRF-Token`
- `analytics-service` — same gap for any mutating endpoints it exposes

Partial mitigation already in place: the `token` cookie is `SameSite=strict`,
which blocks cross-origin requests in all modern browsers. The CSRF token check
is defence-in-depth that covers older browsers and any future relaxation of the
`SameSite` policy.

## Requirements

### Functional

- **R1:** The `shared/` module shall expose `csrfMiddleware` and
  `generateCsrfToken` / `verifyCsrfToken` so all services can import them without
  duplicating code.
- **R2:** The `url-service` shall apply `csrfMiddleware` to all state-mutating
  routes (`POST`, `PUT`, `PATCH`, `DELETE`). Behaviour shall be identical to
  auth-service: skip when no cookie is present, return 403 when cookie is present
  but `X-CSRF-Token` header is missing or invalid.
- **R3:** The `analytics-service` shall apply `csrfMiddleware` to all
  state-mutating routes.
- **R4:** The `auth-service` shall be refactored to import `csrfMiddleware` and
  `csrf.service` from `shared/` instead of its local copies, keeping behaviour
  identical.
- **R5:** The web-ui shall send the `X-CSRF-Token` header (already fetched from
  `GET /csrf-token`) on all mutating requests to url-service and analytics-service,
  not just to auth-service.

### Non-Functional

- **R6:** No new npm packages shall be introduced — the CSRF implementation uses
  Node's built-in `crypto` module only.
- **R7:** Existing unit tests for auth-service shall remain green with zero changes
  to test logic (only import paths change).
- **R8:** Each service's integration tests shall include at least one case covering
  the CSRF 403 path for a cookie-authenticated mutating request.

## Acceptance Criteria

- [ ] `POST /urls` with cookie auth and no `X-CSRF-Token` returns 403.
- [ ] `DELETE /urls/:id` with cookie auth and a valid `X-CSRF-Token` succeeds.
- [ ] `POST /urls` with a Bearer token and no `X-CSRF-Token` succeeds (Bearer
  requests are exempt).
- [ ] The CSRF token fetched from auth-service's `GET /csrf-token` is accepted by
  url-service and analytics-service (same secret, same derivation).
- [ ] All existing auth-service tests pass after the refactor to shared imports.

## Out of Scope

- Moving `GET /csrf-token` to a dedicated gateway or shared service — it stays
  on auth-service
- CSRF protection for preview-service (Python/FastAPI, separate tech stack)
- Refresh token rotation or CSRF token rotation on each request

## Docs to Update

- [ ] `docs/openapi.yaml` — add `X-CSRF-Token` header requirement to mutating
  endpoints in url-service and analytics-service sections

## Tasks

<!--
Generated by Claude from the requirements above. Do not write these manually.
Ask Claude: "Generate tasks for this spec."
-->
