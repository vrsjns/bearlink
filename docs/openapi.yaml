openapi: 3.0.3
info:
  title: BearLink API
  description: |
    REST API specification for BearLink URL shortening service.

    For async event documentation, see [AsyncAPI specification](./asyncapi.yaml).
  version: 2.0.0
  contact:
    name: BearLink Team

servers:
  - url: http://localhost:{port}
    description: Development server
    variables:
      port:
        enum:
          - '4000'
          - '5000'
          - '6000'
          - '7000'
        default: '5000'

tags:
  - name: auth
    description: Authentication and user management (port 4000)
  - name: urls
    description: URL shortening operations (port 5000)
  - name: redirect
    description: Public redirect and link resolution endpoints (port 5000)
  - name: analytics
    description: Event analytics (port 6000)
  - name: notification
    description: Notification service (port 7000)
  - name: health
    description: Health and readiness checks

paths:
  # ─── Auth Service Endpoints ──────────────────────────────────────────────────

  /register:
    post:
      tags: [auth]
      summary: Register new user
      description: Creates a new user account and returns a JWT token
      operationId: registerUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Validation error (missing fields, invalid email, weak password)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /login:
    post:
      tags: [auth]
      summary: User login
      description: >
        Authenticates the user. On success, sets the JWT as an `httpOnly`,
        `SameSite=strict` cookie named `token`. The token string is **not**
        included in the response body. After 5 consecutive failed attempts the
        email is locked out for 15 minutes (429).
      operationId: loginUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful — JWT set as httpOnly cookie
          headers:
            Set-Cookie:
              description: httpOnly JWT cookie
              schema:
                type: string
                example: token=eyJ...; Path=/; HttpOnly; SameSite=Strict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Missing email or password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Account locked after 5 consecutive failed attempts (15-minute cooldown)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /logout:
    post:
      tags: [auth]
      summary: Log out
      description: Clears the `token` httpOnly cookie and returns 204.
      operationId: logoutUser
      security:
        - cookieAuth: []
      responses:
        '204':
          description: Logged out successfully

  /csrf-token:
    get:
      tags: [auth]
      summary: Get CSRF token
      description: >
        Returns a CSRF token derived from the current JWT cookie (HMAC-SHA256).
        Clients must include this value as the `X-CSRF-Token` header on all
        state-mutating requests (POST, PUT, PATCH, DELETE) when using cookie
        authentication.
      operationId: getCsrfToken
      security:
        - cookieAuth: []
      responses:
        '200':
          description: CSRF token
          content:
            application/json:
              schema:
                type: object
                properties:
                  csrfToken:
                    type: string
                    example: a3f8b2c1d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1
        '401':
          $ref: '#/components/responses/Unauthorized'

  /users:
    get:
      tags: [auth]
      summary: List all users
      description: Returns all registered users (admin only)
      operationId: listUsers
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /profile:
    get:
      tags: [auth]
      summary: Get current user profile
      description: Returns the authenticated user's profile data
      operationId: getCurrentUserProfile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{userId}:
    get:
      tags: [auth]
      summary: Get user by ID
      description: Returns a specific user (self or admin only)
      operationId: getUserById
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/userId'
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags: [auth]
      summary: Update user profile
      description: |
        Updates user profile (self or admin only).
        Email changes require current password verification.
        Returns a new JWT token when name or email changes.
      operationId: updateUserProfile
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/userId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateProfileResponse'
        '400':
          description: Validation error (invalid name or email format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Insufficient permissions or invalid password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already in use
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [auth]
      summary: Delete user
      description: Permanently deletes a user account (admin only)
      operationId: deleteUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/userId'
      responses:
        '204':
          description: User deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{userId}/password:
    post:
      tags: [auth]
      summary: Change user password
      description: |
        Changes user password (self or admin only).
        Requires current password verification.
        Has stricter rate limiting (5 requests per 15 minutes).
      operationId: changeUserPassword
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/userId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
      responses:
        '200':
          description: Password changed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Password changed successfully.
        '400':
          description: Validation error (weak password, same as current)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Invalid current password or insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many requests (rate limited)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─── URL Service Endpoints ───────────────────────────────────────────────────

  /urls:
    get:
      tags: [urls]
      summary: List user's URLs
      description: Returns paginated shortened URLs created by the authenticated user, with optional filtering.
      operationId: listUrls
      security:
        - bearerAuth: []
      parameters:
        - name: page
          in: query
          description: Page number (1-based)
          schema:
            type: integer
            minimum: 1
            default: 1
            example: 1
        - name: limit
          in: query
          description: Items per page (max 100)
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: tag
          in: query
          description: Filter by tag
          schema:
            type: string
            example: marketing
        - name: search
          in: query
          description: Search in originalUrl and customAlias (case-insensitive)
          schema:
            type: string
            example: example.com
        - name: expired
          in: query
          description: Filter by expiry status
          schema:
            type: string
            enum: ['true', 'false']
            example: 'false'
      responses:
        '200':
          description: Paginated list of URLs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListUrlsResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'

    post:
      tags: [urls]
      summary: Create shortened URL
      description: |
        Creates a new shortened URL for the authenticated user.

        The destination URL is validated against the Google Safe Browsing API (if configured)
        and domain allowlist/blocklist rules.

        If `requireSignature` is set to `true`, the response also includes a pre-signed
        `signedUrl` that embeds an expiring HMAC signature. Unsigned requests to this link
        will be rejected with 403.
      operationId: createUrl
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUrlRequest'
      responses:
        '200':
          description: URL created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateUrlResponse'
        '400':
          description: Validation error (missing fields, invalid format)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Custom alias already taken
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: URL rejected by domain filter or Safe Browsing check
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /urls/bulk:
    post:
      tags: [urls]
      summary: Bulk create shortened URLs
      description: |
        Creates up to 50 shortened URLs in a single request.
        Each item is processed independently — if one fails validation or DB insertion,
        the others still succeed. Returns a `results` array where each entry is either
        `{ shortUrl }` on success or `{ error }` on failure.
      operationId: createUrlsBulk
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BulkCreateUrlRequest'
      responses:
        '200':
          description: Partial or full success — check individual result entries for errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BulkCreateUrlResponse'
        '400':
          description: Top-level validation error (not an array, empty, or exceeds 50)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /urls/{id}:
    put:
      tags: [urls]
      summary: Update URL
      description: |
        Updates an existing shortened URL. Only the owner can update their URL.

        The new destination URL is validated against the domain filter and Safe Browsing API.
        Cache entries for this URL are invalidated on success.
      operationId: updateUrl
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/urlId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUrlRequest'
      responses:
        '200':
          description: URL updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Url'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: URL not found or not owned by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Custom alias already taken
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: URL rejected by domain filter or Safe Browsing check
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags: [urls]
      summary: Delete URL
      description: Permanently deletes a shortened URL. Cache entries are invalidated on success.
      operationId: deleteUrl
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/urlId'
      responses:
        '204':
          description: URL deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: URL not found or not owned by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /urls/{id}/sign:
    post:
      tags: [urls]
      summary: Generate a signed URL
      description: |
        Creates a time-limited, HMAC-signed version of the short URL.
        The signed URL includes `?exp=<unix-timestamp>&sig=<hmac-sha256>` query parameters.

        Requires `URL_SIGNING_SECRET` to be configured on the server.
        Signed URLs are useful for distributing links that expire automatically
        or that you want to prevent from being shared beyond the intended recipient.
      operationId: signUrl
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/urlId'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignUrlRequest'
      responses:
        '200':
          description: Signed URL generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignUrlResponse'
        '400':
          description: Invalid URL ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          description: URL not found or not owned by user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: URL signing not configured (missing URL_SIGNING_SECRET)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─── Public Redirect Endpoints ───────────────────────────────────────────────

  /{shortId}:
    get:
      tags: [redirect]
      summary: Redirect to original URL
      description: |
        Resolves a short ID or custom alias and redirects to the original URL.

        **Click tracking:** Human clicks are deduplicated per IP per hour using Redis.
        Bot requests (detected by User-Agent) are redirected but not counted.

        **Preview mode:** Add `?preview=1` to show an HTML bounce page with link metadata
        instead of redirecting. No click is counted in preview mode.

        **Signed URLs:** If the link has `requireSignature=true`, the request must include
        valid `?sig=<hmac>&exp=<unix>` parameters (obtained via `POST /urls/:id/sign`).

        **Caching:** URL lookups are served from Redis (60s TTL) when available.
      operationId: redirectUrl
      parameters:
        - name: shortId
          in: path
          required: true
          description: The 10-character short identifier or custom alias (3-50 chars)
          schema:
            type: string
            example: abc123xyz9
        - name: preview
          in: query
          description: Set to "1" to show an HTML preview page instead of redirecting
          schema:
            type: string
            enum: ['1']
        - name: sig
          in: query
          description: HMAC-SHA256 signature (required when link has requireSignature=true)
          schema:
            type: string
            example: a3f9c2e1b8d4...
        - name: exp
          in: query
          description: Signature expiry as Unix timestamp (required with sig)
          schema:
            type: integer
            example: 1740700000
      responses:
        '200':
          description: HTML preview page (only when ?preview=1)
          content:
            text/html:
              schema:
                type: string
        '301':
          description: Permanent redirect to original URL
          headers:
            Location:
              description: The original URL (with UTM params appended if configured)
              schema:
                type: string
                format: uri
        '302':
          description: Temporary redirect to original URL
          headers:
            Location:
              description: The original URL (with UTM params appended if configured)
              schema:
                type: string
                format: uri
        '400':
          description: URL is unsafe (blocked by isSafeRedirectUrl check)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Link is password-protected — submit password via POST /:shortId/unlock
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Error'
                  - type: object
                    properties:
                      requiresPassword:
                        type: boolean
                        example: true
        '403':
          description: Invalid, tampered, or expired HMAC signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Short URL not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Link has expired (expiresAt is in the past)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /{shortId}/qr:
    get:
      tags: [redirect]
      summary: Generate QR code for a short link
      description: |
        Returns a PNG QR code image encoding the full short URL.
        The QR code points to the short URL (not the original URL).
        Returns 410 if the link has already expired.
      operationId: getQrCode
      parameters:
        - name: shortId
          in: path
          required: true
          description: The short identifier or custom alias
          schema:
            type: string
            example: abc123xyz9
      responses:
        '200':
          description: PNG QR code image
          content:
            image/png:
              schema:
                type: string
                format: binary
        '404':
          description: Short URL not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Link has expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /{shortId}/unlock:
    post:
      tags: [redirect]
      summary: Unlock a password-protected link
      description: |
        Verifies the password for a protected link and redirects to the original URL.
        On success, a `url_clicked` event is published and the click counter is incremented.
      operationId: unlockUrl
      parameters:
        - name: shortId
          in: path
          required: true
          description: The short identifier or custom alias
          schema:
            type: string
            example: abc123xyz9
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnlockRequest'
      responses:
        '302':
          description: Password correct — redirect to original URL
          headers:
            Location:
              schema:
                type: string
                format: uri
        '400':
          description: Missing password or link is not password-protected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Incorrect password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Short URL not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Link has expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ─── Analytics Service Endpoints ─────────────────────────────────────────────

  /events:
    get:
      tags: [analytics]
      summary: List all events
      description: Returns all stored domain events
      operationId: listEvents
      responses:
        '200':
          description: List of events
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Event'

  # ─── Health Endpoints (all services) ─────────────────────────────────────────

  /health:
    get:
      tags: [health]
      summary: Health check
      description: Returns 200 if the service is running
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /ready:
    get:
      tags: [health]
      summary: Readiness check
      description: |
        Returns 200 if the service is ready to accept requests.
        Checked dependencies vary by service:
        - **url-service:** database, rabbitmq, redis (non-fatal if Redis is down)
        - **auth-service:** database, rabbitmq
        - **analytics-service:** database, rabbitmq
        - **notification-service:** database, smtp
      operationId: readinessCheck
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadyResponse'
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadyResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /login or /register (API clients only)

    cookieAuth:
      type: apiKey
      in: cookie
      name: token
      description: JWT stored in an httpOnly, SameSite=strict cookie — set automatically by /login and /register, cleared by /logout

  parameters:
    userId:
      name: userId
      in: path
      required: true
      description: User ID
      schema:
        type: integer
        example: 1

    urlId:
      name: id
      in: path
      required: true
      description: URL record ID
      schema:
        type: integer
        example: 1

  responses:
    Unauthorized:
      description: Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:

    # ── Auth ──────────────────────────────────────────────────────────────────

    RegisterRequest:
      type: object
      required:
        - email
        - password
        - name
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          minLength: 6
          example: securepassword123
        name:
          type: string
          example: John Doe

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          example: securepassword123

    AuthResponse:
      type: object
      description: >
        Returned by /login and /register. The JWT is delivered as an httpOnly
        cookie (`Set-Cookie: token=...`), not in the response body.
      properties:
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        email:
          type: string
          format: email
          example: user@example.com
        name:
          type: string
          example: John Doe
        role:
          type: string
          enum: [USER, ADMIN]
          example: USER
        createdAt:
          type: string
          format: date-time
          example: '2024-01-15T10:30:00.000Z'

    UpdateProfileRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          description: New display name
          example: Jane Doe
        email:
          type: string
          format: email
          description: New email address (requires currentPassword)
          example: jane@example.com
        currentPassword:
          type: string
          description: Required when changing email
          example: CurrentPassword123

    UpdateProfileResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/User'
        token:
          type: string
          description: New JWT token (issued when name or email changes)
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

    ChangePasswordRequest:
      type: object
      required:
        - currentPassword
        - newPassword
      properties:
        currentPassword:
          type: string
          description: Current password for verification
          example: OldPassword123
        newPassword:
          type: string
          minLength: 8
          description: New password (min 8 chars, uppercase, lowercase, number)
          example: NewPassword456

    # ── URL management ────────────────────────────────────────────────────────

    CreateUrlRequest:
      type: object
      required:
        - originalUrl
      properties:
        originalUrl:
          type: string
          format: uri
          description: The URL to shorten (must be http or https)
          example: https://example.com/very/long/path
        redirectType:
          type: integer
          enum: [301, 302]
          default: 302
          description: HTTP redirect type (301 = permanent, 302 = temporary)
          example: 302
        customAlias:
          type: string
          minLength: 3
          maxLength: 50
          pattern: '^[a-zA-Z0-9_-]{3,50}$'
          description: Custom slug to use instead of a generated short ID
          example: my-campaign
        expiresAt:
          type: string
          format: date-time
          description: When the link expires (must be in the future)
          example: '2027-01-01T00:00:00.000Z'
        password:
          type: string
          description: Protect the link with a password (stored as bcrypt hash)
          example: secret123
        tags:
          type: array
          items:
            type: string
          description: Arbitrary string tags for filtering and organisation
          example: [marketing, q1]
        utmParams:
          type: object
          description: |
            UTM parameters to append to the destination URL on redirect.
            All values must be strings or numbers.
          additionalProperties:
            type: string
          example:
            utm_source: newsletter
            utm_medium: email
            utm_campaign: spring-sale
        requireSignature:
          type: boolean
          default: false
          description: |
            If true, redirect requests must include a valid HMAC signature
            (obtained from POST /urls/:id/sign or returned in the creation response).
          example: false
        signedTtl:
          type: integer
          minimum: 1
          description: |
            Validity window in seconds for the initial signed URL returned in the response
            (only relevant when requireSignature=true). Defaults to 3600 (1 hour).
          example: 86400

    UpdateUrlRequest:
      type: object
      required:
        - originalUrl
      properties:
        originalUrl:
          type: string
          format: uri
          description: New destination URL
          example: https://example.com/updated/path
        redirectType:
          type: integer
          enum: [301, 302]
          description: HTTP redirect type
          example: 302
        customAlias:
          type: string
          minLength: 3
          maxLength: 50
          pattern: '^[a-zA-Z0-9_-]{3,50}$'
          nullable: true
          description: New custom alias, or null to remove the existing alias
          example: new-alias
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: New expiry (must be in the future), or null to remove expiry
          example: '2027-06-01T00:00:00.000Z'
        password:
          type: string
          nullable: true
          description: New password, or null to remove password protection
          example: newpassword
        tags:
          type: array
          items:
            type: string
          description: Replace all tags with this list
          example: [social, organic]
        utmParams:
          type: object
          nullable: true
          description: Replace UTM params with this object, or null to remove them
          additionalProperties:
            type: string
          example:
            utm_source: twitter
        requireSignature:
          type: boolean
          description: Enable or disable signature enforcement
          example: true

    BulkCreateUrlRequest:
      type: object
      required:
        - urls
      properties:
        urls:
          type: array
          minItems: 1
          maxItems: 50
          description: Array of URL creation requests (max 50)
          items:
            $ref: '#/components/schemas/CreateUrlRequest'

    BulkCreateUrlResponse:
      type: object
      properties:
        results:
          type: array
          description: |
            One entry per input item. Each entry is either a success
            `{ shortUrl }` or a failure `{ error }`.
          items:
            oneOf:
              - type: object
                properties:
                  shortUrl:
                    type: string
                    format: uri
                    example: http://localhost:5000/abc123xyz9
              - type: object
                properties:
                  error:
                    type: string
                    example: Custom alias is already taken.

    CreateUrlResponse:
      type: object
      properties:
        shortUrl:
          type: string
          format: uri
          description: The full shortened URL
          example: http://localhost:5000/abc123xyz9
        signedUrl:
          type: string
          format: uri
          description: |
            Pre-signed URL with HMAC signature appended (only present when
            requireSignature=true and URL_SIGNING_SECRET is configured).
          example: http://localhost:5000/abc123xyz9?exp=1740700000&sig=a3f9c2...

    SignUrlRequest:
      type: object
      properties:
        ttl:
          type: integer
          minimum: 1
          description: Validity window in seconds (default 3600)
          example: 86400

    SignUrlResponse:
      type: object
      properties:
        signedUrl:
          type: string
          format: uri
          description: The signed URL with ?exp and ?sig query parameters appended
          example: http://localhost:5000/abc123xyz9?exp=1740786400&sig=7b2e41...

    UnlockRequest:
      type: object
      required:
        - password
      properties:
        password:
          type: string
          description: The password to verify
          example: secret123

    Url:
      type: object
      description: A shortened URL record
      properties:
        id:
          type: integer
          example: 1
        originalUrl:
          type: string
          format: uri
          example: https://example.com/very/long/path
        shortId:
          type: string
          description: Auto-generated 10-character identifier
          example: abc123xyz9
        customAlias:
          type: string
          nullable: true
          description: Custom slug (3-50 chars, alphanumeric + hyphen + underscore)
          example: my-campaign
        redirectType:
          type: integer
          enum: [301, 302]
          example: 302
        expiresAt:
          type: string
          format: date-time
          nullable: true
          example: '2027-01-01T00:00:00.000Z'
        tags:
          type: array
          items:
            type: string
          example: [marketing, q1]
        utmParams:
          type: object
          nullable: true
          additionalProperties:
            type: string
          example:
            utm_source: newsletter
            utm_medium: email
        requireSignature:
          type: boolean
          default: false
          example: false
        clicks:
          type: integer
          minimum: 0
          example: 42
        userId:
          type: integer
          example: 1
        createdAt:
          type: string
          format: date-time
          example: '2024-01-15T10:30:00.000Z'
        previewTitle:
          type: string
          nullable: true
          description: Page title scraped by preview-service (async)
          example: Example Domain
        previewDescription:
          type: string
          nullable: true
          description: Meta description scraped by preview-service (async)
          example: This domain is for use in illustrative examples.
        previewImageUrl:
          type: string
          nullable: true
          description: OG image URL scraped by preview-service (async)
          example: https://example.com/og-image.png
        previewFetchedAt:
          type: string
          format: date-time
          nullable: true
          description: When the preview metadata was last fetched
          example: '2024-01-15T10:31:00.000Z'

    ListUrlsResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Url'
        pagination:
          type: object
          properties:
            page:
              type: integer
              example: 1
            limit:
              type: integer
              example: 20
            total:
              type: integer
              example: 87
            pages:
              type: integer
              example: 5

    # ── Analytics ─────────────────────────────────────────────────────────────

    Event:
      type: object
      properties:
        id:
          type: integer
          example: 1
        type:
          type: string
          enum: [user_registered, url_created, url_updated, url_deleted, url_clicked]
          example: url_clicked
        payload:
          type: object
          description: Event-specific data (see AsyncAPI spec for schemas)
        createdAt:
          type: string
          format: date-time
          example: '2024-01-15T10:30:00.000Z'

    # ── Health ────────────────────────────────────────────────────────────────

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok]
          example: ok

    ReadyResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, error]
          example: ok
        checks:
          type: object
          properties:
            database:
              type: string
              enum: [ok, error]
            rabbitmq:
              type: string
              enum: [ok, error]
            redis:
              type: string
              enum: [ok, error]
              description: Present in url-service (non-fatal — service starts without Redis)
            smtp:
              type: string
              enum: [ok, error]
              description: Only present in notification-service

    # ── Shared ────────────────────────────────────────────────────────────────

    Error:
      type: object
      properties:
        error:
          type: string
          description: Human-readable error message
          example: Invalid credentials
